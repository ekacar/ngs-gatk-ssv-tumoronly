# File: preprocessing.smk
# Author: Emrah Kacar
# Email: kacar.emrah@gmail.com
# Description:
# Creates analysis ready bam files according to the GATK best practices guide. 

rule bwa_index:
    input:
        "data/Homo_sapiens_assembly38.fasta",
    output:
        multiext("data/Homo_sapiens_assembly38.fasta", ".amb", ".ann", ".bwt", ".pac", ".sa"),
    singularity:
        gatk_env, 
    log:
        "logs/bwa_index.log",
    shell:
        """
        bwa index {input}
        """

rule bwa:
    input:
        bwt_files=[f"{ref_fasta}.{suffix}" for suffix in file_suffixes],
        bam="bams/{patient}.{sample_type}.{readgroup}.unaligned.bam",
        ref=ref_fasta
    output:
        temp("bams/{patient}.{sample_type}.{readgroup}.aligned.bam")
    threads: 8
    singularity: gatk_env
    shell:
        """
        gatk SamToFastq -I {input.bam} -F /dev/stdout -INTER true -NON_PF true \
        | \
        bwa mem -p -v 3 -t {threads} -T 0 \
            {input.ref} /dev/stdin - 2> >(tee {log} >&2) \
        | \
        samtools view -Shb -o {output}
        """
